<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script type="text/javascript" src="bower_components/jquery/dist/jquery.js"></script>
    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript" src="openseadragon.js"></script>
</head>
<body>

    <div id="viewer" style="width: 800px; height: 600px; background: #000"></div>

    <script>

        var isFirstLoad = true;
        var viewer, tileSources, currentBounds;

        window.onresize = resize;

        function resize() {
            $('#viewer').width(window.innerWidth);
            $('#viewer').height(window.innerHeight);
        }

        $(function() {

            tileSources = [{"tileSource":"http://wellcomelibrary.org/iiif-img/b19684915-0/35d6488f-8821-42b3-a550-39373b7e7e81/info.json"},{"tileSource":"http://wellcomelibrary.org/iiif-img/b19684915-0/7c6be516-8e28-4806-a120-359368a21a03/info.json"}];

            viewer = OpenSeadragon({
                id: "viewer"
            });

            viewer.addHandler('open', openTileSourcesHandler, this);

            viewer.addHandler('animation-finish', function() {
                console.log(viewer.viewport.getZoom(true));

                currentBounds = getBounds();

                setHashParameter('bounds', serialiseBounds(currentBounds));
            });

            resize();

            viewer.open(tileSources[0]);
        });

        function openTileSourcesHandler() {

            viewer.removeHandler('open', this.handler);

            var viewingDirection = "left-to-right";

            // if there's more than one tilesource, align them next to each other.
            if (tileSources.length > 1) {
                // check if tilesources should be aligned horizontally or vertically
                if (viewingDirection == "top-to-bottom" || viewingDirection == "bottom-to-top") {
                    // vertical
                    tileSources[1].y = viewer.world.getItemAt(0).getBounds().y + viewer.world.getItemAt(0).getBounds().height + 0.01;
                } else {
                    // horizontal
                    tileSources[1].x = viewer.world.getItemAt(0).getBounds().x + viewer.world.getItemAt(0).getBounds().width + 0.01;
                }

                viewer.addTiledImage(tileSources[1]);
            }

            initialBounds = getHashParameter('bounds');

            if (initialBounds) {
                initialBounds = deserialiseBounds(initialBounds);
                currentBounds = initialBounds;
                fitToBounds(currentBounds);
            }
        }

        function fitToBounds(bounds) {
            var rect = new OpenSeadragon.Rect();
            rect.x = bounds.x;
            rect.y = bounds.y;
            rect.width = bounds.width;
            rect.height = bounds.height;

            viewer.viewport.fitBounds(rect, true);
        }

        function getBounds() {
            return viewer.viewport.getBounds(true);
        }

        function serialiseBounds(bounds){
            return bounds.x + ',' + bounds.y + ',' + bounds.width + ',' + bounds.height;
        }

        function deserialiseBounds(bounds) {
            var boundsArr = bounds.split(',');

            return {
                x: Number(boundsArr[0]),
                y: Number(boundsArr[1]),
                width: Number(boundsArr[2]),
                height: Number(boundsArr[3])
            };
        }

    </script>

</body>
</html>